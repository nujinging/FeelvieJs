<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="../css/reset.css"/>
    <link rel="stylesheet" href="../css/common.css"/>
    <link rel="stylesheet" href="../css/list.css"/>
    <link rel="stylesheet" href="../css/detail.css" />

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="../services/movieApi.js"></script>
    <title>Document</title>
  </head>
  <body>
    <div id="root">

        <div class="item_container detail">
            <div class="item_box" data-section="credits">
                <div class="title"><h2>ë“±ì¥ì¸ë¬¼</h2></div>
                <div class="swiper item_slide">
                    <div class="swiper-wrapper credits"></div>
                </div>
                <div class="swiper-button-prev swiper-button-disabled swiper-button-lock"></div>
                <div class="swiper-button-next swiper-button-disabled swiper-button-lock"></div>
            </div>
            <!-- // credits -->

            <div class="item_box" data-section="media">
                <div class="title">
                    <h2>ë¯¸ë””ì–´</h2>
                    <ul class="type_list">
                        <li><button type="button" class="active">ë™ì˜ìƒ 3</button></li>
                        <li><button type="button" class="">ë°°ê²½ 32</button></li>
                        <li><button type="button" class="">í¬ìŠ¤í„° 24</button></li>
                    </ul>
                </div>
                <div class="swiper media_slide swiper-backface-hidden">
                    <div class="swiper-wrapper media">
                        <div class="swiper-slide video_card swiper-slide-active"><img src="https://i.ytimg.com/vi/Bldf9SWRPFM/hqdefault.jpg" alt=""></div>
                        <div class="swiper-slide video_card swiper-slide-next"><img src="https://i.ytimg.com/vi/OyD-JZSYjXc/hqdefault.jpg" alt=""></div>
                        <div class="swiper-slide video_card"><img src="https://i.ytimg.com/vi/Ac7j_wLYJ9Y/hqdefault.jpg" alt=""></div>
                    </div>
                </div>
            </div>
            <!-- // media -->

            <div class="item_box" data-section="recommend">
                <div class="title"><h2>ì¶”ì²œ ì‘í’ˆ</h2></div>
                <div class="swiper item_slide item_list swiper-backface-hidden">
                    <div class="swiper-wrapper recommend"></div>
                    <div class="swiper-button-prev swiper-button-disabled swiper-button-lock"></div>
                    <div class="swiper-button-next swiper-button-disabled swiper-button-lock"></div>
                </div>
            </div>
            <!-- // recommend -->
        </div>
    </div>

    <script>

        const locationQuery = location.href.split("?")[1].split("/");
        const locationType = locationQuery[0];
        const locationId = locationQuery[1];

        const swiper = new Swiper(".item_slide", {
            slidesPerView: "auto",
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
        });

        const render = async (type, id) => {
            const fetchBasic = await movieApi.detail(type, id);
            const fetchSocial = await movieApi.social(type, id);
            const fetchCredits = await movieApi.credits(type, id);
            const fetchRecommend = await movieApi.recommend(type, id);
            const data = fetchBasic.data;
            const socialData = fetchSocial.data;
            const creditsData = fetchCredits.data.cast;
            const recommendData = fetchRecommend.data.results;

            console.log(data);
            console.log(socialData);
            console.log(creditsData);
            console.log(recommendData);

            const transAdult = age => {
                return age == false ? "ì „ì²´ì—°ë ¹ê°€" : "ì• ë“¤ì€ ìë¼";
            };

            const transRuntime = runtime => {
                const hour = Math.floor(runtime / 60);
                const minute = Math.floor(((runtime / 60) * 100) / 10);

                return `${hour}ì‹œê°„ ${minute}ë¶„`;
            };

            const handleSocial = () => {
                const socialMedia = [
                    {name: 'í˜ì´ìŠ¤ë¶', url: 'http://www.facebook.com', class: "facebook", link: `${socialData?.facebook_id}`},
                    {name: 'íŠ¸ìœ„í„°', url: 'http://www.twitter.com', class: "twitter", link: `${socialData?.twitter_id}`},
                    {name: 'ì¸ìŠ¤íƒ€ê·¸ë¨', url: 'http://www.instagram.com', class: "instagram", link: `${socialData?.instagram_id}`}
                ];
                
                const socialTemplate = socialMedia.map((social) => 
                !!social.link ? (
                    `<li>
                        <a 
                            href="${social.url}/${social.link}"
                            class="${social.class}"
                            target="_blank"
                            rel="noreferrer"
                        >
                            <span class="blind">${social.name}</span>
                        </a>
                    </li>`
                ) : null).join("");
                return socialTemplate;
            }

            const detailTemplate = `
                <section
                    class="detail_container"
                    style="background-image: url('https://image.tmdb.org/t/p/w1920_and_h800_multi_faces/${data.backdrop_path}');"
                >
                    <div class="detail_info">
                        <h1 class="tit">${data.title}</h1>
                        <div class="meta">
                            <span class="type">Moive</span><span class="date">${data.release_date}</span>
                        </div>
                        <div class="meta">
                            <span class="txt">${transAdult(data.adult)}</span>
                            <span class="txt">${data.genres[0].name}</span>
                            <span class="txt">ë²”ì£„</span><span class="txt">${data.genres[1].name}</span>
                        </div>
                        <div class="comment">
                            <p class="intro">${data.overview}</p>
                        </div>
                    </div>
                    <div class="detail_poster">
                        <ul class="social_links">${handleSocial()}</ul>
                        <picture
                        ><img
                            src="https://media.themoviedb.org/t/p/w300_and_h450_bestv2${data.poster_path}"
                            alt="Movie Poster"
                            loading="lazy"
                        /></picture>
                    </div>
                </section>
            `;
            document.querySelector("#root").insertAdjacentHTML("afterbegin", detailTemplate);

            const insertCredits = () => {
                const moreCredits = `
                    <a class="credits_more" href="/detail/movie/${id}/credits">ë”ë³´ê¸°</a>
                `;
                document.querySelector(".item_container .title").insertAdjacentHTML("beforeend", moreCredits);

                creditsData.forEach((cast, index) => {
                    const itemBox = document.createElement('div');
                    itemBox.classList.add('swiper-slide');
                    itemBox.classList.add('list_card');
                    itemBox.classList.add('person_card');
                    document.querySelector('.swiper-wrapper.credits').append(itemBox);

                    const itemInfo = `
                        <a href="/person/${cast.id} ">
                            <img src="https://image.tmdb.org/t/p/w154/${cast.profile_path}" alt="${cast.name}" loading="lazy">
                            <h3>${cast.name}</h3>
                        </a>
                    `;
                    itemBox.innerHTML = itemInfo;
                });
            }
            insertCredits();

            const selectMedia = () => {
                console.log(document.querySelector('.item_box[data-section="media"] .type-list'));

            }
            selectMedia();
            const insertMedia = () => {
                
            }

            const insertRecommend = () => {
                if(recommendData.length == 0) {
                    const recommendNone = `<p class="recommend_none">ğŸ˜¢ ì•ˆë°ìŠ¤ ì„¤ì›ì˜ ìƒì¡´ìë“¤ì˜ ì¶©ë¶„í•œ í‰ê°€ê°€ ì´ë¤„ì§€ì§€ì•Šì•„ ì•„ì§ ì¶”ì²œë“œë¦´ ì‘í’ˆì´ ì—†ì–´ìš”<br></p>`;
                    document.querySelector('.item_box[data-section="recommend"]').insertAdjacentHTML('beforeend', recommendNone);
                }
                recommendData.forEach((recommend, index) => {
                    const itemBox = document.createElement('div');
                    itemBox.classList.add('swiper-slide');
                    itemBox.classList.add('list_card');
                    itemBox.classList.add('item_card');
                    document.querySelector('.swiper-wrapper.recommend').append(itemBox);

                    const itemInfo = `
                        <div class="swiper-slide list_card item_card swiper-slide-active">
                            <a href="/detail/movie/${recommend.id} ">
                                <img src="https://image.tmdb.org/t/p/w220_and_h330_face/${recommend.poster_path}" alt="${recommend.title}" loading="lazy">
                                <h3>${recommend.title}</h3>
                            </a>
                        </div>
                    `;
                    itemBox.innerHTML = itemInfo;
                });
            }
            insertRecommend();
        };
        
        render(locationType, locationId);
    </script>
  </body>
</html>
